{% extends 'projects/base.html' %}

{% block auth_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-project-diagram"></i> Mis Proyectos
    </h2>
    <a href="{% url 'projects:create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> 
        {% if projects %}Nuevo Proyecto{% else %}Crear Primer Proyecto{% endif %}
    </a>
</div>

{% if projects %}
    <div class="row">
        {% for project in projects %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">{{ project.name }}</h5>
                        <span class="badge bg-{{ project.status|default:'secondary' }}">
                            {{ project.status|title }}
                        </span>
                    </div>
                    <p class="card-text text-muted">
                        {{ project.description|truncatewords:15|default:'Sin descripción' }}
                    </p>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-user"></i> {{ project.owner.username }}
                        </small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-users"></i> {{ project.members|length }} miembros
                        </small>
                    </div>
                    {% if project.start_date %}
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> {{ project.start_date }}
                        </small>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'projects:detail' project.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                        <a href="{% url 'projects:update' project.id %}" class="btn btn-outline-warning">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <button class="btn btn-outline-danger js-delete-project" data-project-id="{{ project.id }}" type="button">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No tienes proyectos aún</h4>
        <p class="text-muted">Crea tu primer proyecto para empezar a organizar tus tareas.</p>
    </div>
{% endif %}

<div class="mt-4 text-muted">
    <small>Total: {{ projects_count }} proyecto{{ projects_count|pluralize }}</small>
</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function editProject(id) {
    alert('Función de editar proyecto #' + id + ' - Próximamente');
}

function deleteProject(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este proyecto?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/projects/${id}/delete/`;

        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = getCookie('csrftoken');
        form.appendChild(csrf);

        document.body.appendChild(form);
        form.submit();
    }
}

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.js-edit-project').forEach(function (btn) {
        btn.addEventListener('click', function () {
            editProject(btn.dataset.projectId);
        });
    });

    document.querySelectorAll('.js-delete-project').forEach(function (btn) {
        btn.addEventListener('click', function () {
            deleteProject(btn.dataset.projectId);
        });
    });
});
</script>
{% endblock %}
